<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>bridge</title>
    <link href="asset/bs/css/bootstrap.css" rel="stylesheet">
    <link href="asset/bootstrap-treeview/dist/bootstrap-treeview.min.css" rel="stylesheet">
    <script src="asset/jquery/dist/jquery.min.js"></script>
    <script src="asset/bootstrap-treeview/dist/bootstrap-treeview.min.js"></script>
    <script src="asset/bridge.js"></script>
</head>
<body>

<div>
    <div class="row" style="margin: 30px">
        <div class="col-lg-7 col-md-7 col-sm-7">
            <div id="tree"></div>
        </div>
        <div class="col-lg-5 col-md-5 col-sm-5">
            <form class="form-horizontal">
                <div class="form-group">
                    <label class="col-sm-2 control-label"> </label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="parameter" placeholder="parameter">
                    </div>
                </div>
                <div class="form-group">
                    <div class=" col-sm-offset-2 col-sm-10">
                        <button type="button" class="btn btn-default" id="invoke">invoke</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class=" col-sm-offset-2 col-sm-10">
                        <textarea class="form-control" rows="3" id="console"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    $(function () {
        function getMethodTitle(method) {
            var paramTypes = method.paramTypes;
            var paramNames = method.paramNames;
            if (paramNames.length > 0)
                for (i in paramNames)
                    paramTypes[i] = paramTypes[i] + ":" + paramNames[i]
            return method.name + "(" + paramTypes.join(',') + ")";
        }

        function showData(data) {
            var tree = [];
            var serviceMap = {}
            for (i in data) {
                var method = data[i]
                if (serviceMap[method.service] == null)
                    serviceMap[method.service] = [];
                serviceMap[method.service].push({
                    'text': getMethodTitle(method),
                    'service': method.service,
                    'method': method.name,
                    'isMethod': true
                })
            }
            for (serviceName in serviceMap)
                tree.push({
                    'text': serviceName,
                    'nodes': serviceMap[serviceName]
                })
            $('#tree').treeview({
                data: tree,
                onNodeSelected: function (event, data) {
                    console.log(data)
                    console.log($('#tree').treeview('getSelected'));
                }
            });
        }

        // ============================ bridge =============================
        var bridge = new Bridge('service/admin', 'HttpBridgeService');
        $('#invoke').click(function () {
            var nodes = $('#tree').treeview('getSelected');
            if (nodes == null || nodes.length == 0) {
                alert("please select method to invoke");
                return;
            }
            var method = nodes[0];
            if (!method.isMethod) {
                alert("please select method, not service");
                return;
            }
            var param = $('#parameter').val();
            if (param == null || param.trim().length == 0) {
                alert("please give param as json");
                return;
            }
            var api = new Bridge('service/api', method.service).useJsonString();
            api.post(method.method, param, function (data) {
                $('#console').val(JSON.stringify(data));
            })

        })
        bridge.post('getApiMethods', null, showData);
    });

</script>

</body>
</html>